# 컴퓨터 구조 및 설계

## 파이프 라이닝

여러 명령어가 중첩 되어 실행되는 구현 기술



### MIPS에서 명령어를 실행하기 위한 5단계 

1. 메모리에서 명령어를 가져온다.
2. 명령어를 해독하는 동시에 레지스터를 읽는다, MIPS 명령어는 형식이 규칙적이므로 읽기와 해독이 동시에 일어날 수 있다.
3. 연상을 수행하거나 주소를 계산한다.
4. 데이터 메모리에 있는 피 연산자에 접근 한다.
5. 결과 값을 레지스터에 쓴다.

 

### 파이프라인된 MIPS 프로세서

- 현재 명령어가 완료 되기 전에 다음 명령어 실행
  - 처리량 향상 - 주어진 시간에 끝낼 수 있는 일들의 총량
  - 명령 대기 시간은 줄어 들지 않는다
- 클락 시간(파이프 라인 실행 클락 시간)은 가장 느린 경우로 제한된다
  - 몇가지 단계는 전체 클락 시간을 필요로 하지 않는다
  - 일부 명령어의 일부 스테이지는 낭비되는 사이클이 있다 (즉, 그 명령어에 대한 그 사이클 동안 아무 것도 수행되지 않는다)



### 파이프라이닝 성능

- 클럭 사이클은 가장 느린 파이프라인 단계에서 요구되는 시간으로 결정
- 파이프라인 단계들이 완벽하게 균형을 이루고 있다면 파이프라인 프로세서에서 명령어 시간은 다음과 같다.
  - 명령어 사이의 시간(파이프 라인) = 명령어 사이의 시간(파이프 라이닝 되지 않은) / 파이프 단계 수
- 클락 사이클 시간이 t인 k-단계의 파이프 라인의 성능 향상
  - n개의 명령어
    - 성능 향상 = n * k * t / ((k-1) * t + n * t) = n * k * t / (k * t ( n - 1)*t)
  - 명령어의 개수가 무한대로 갈때
    - 성능 향상 = k



### 왜 실제 성능 향상이 k보다 작은가?

1. 파이트 라인을 채우기 위한 시간
   - 명령어의 개수는 무한대가 아니다
2. 파이프라인 해저드
   - 일부 클럭 사이클에 명령어가 끝나지 않는다
3. 파이프라인 단계중 불균형이 있다
   - 가장 느린 파이프 라인 단계에 필요한 시간보다 단계가 빠르게 실행될 수 있다
4. 파이프라인 오버헤드
   - 파이프라인 레지스터에 딜레이가 있다
   - 시작 시간 + 클록 시간에 따른 전파 시간



### 파이프 라인 해저드

다음 명령어가 다음 클럭 사이클에 실행될 수 없는 상황

-  구조적 해저드

  - 같은 클럭 사이클에 실행하기를 원하는 명령어의 조합을 하드웨어가 지원 할 수 없다
  - 해결책: 자원의 수를 늘인다

- 데이터 해저드

  - 어떤 단계가 다른 단계가 끝나기를 기다려야 하기 때문에 파이프 라인이 지연된다
  - 해결책: 파이프라인 지연과 전방전달(우회 전달)

- 제어 해저드
  - 다른 명령어들이 실행중에 한 명령어의 결과 같에 기반을 둔 결정을 할 필요가 있을때 발생

  - 해결책: 파이프 라인 지연, 분기 예측, 지연 분기

    

### 명령어 파이프 라인의 5단계

1. IF: 명령어 인출
2. ID: 명령어 해독 및 레지스터 파일 읽기
3. EX: 실행 또는 주소 계산
4. MEM: 데이터 메모리 접근
5. WB: 쓰기(write data)



### 파이프 라인 실행

- 명령어에서는 왼쪽에서 오른쪽으로 흐르는 것에 2가지 예외가 있다-
  - 쓰기 단계: ALU의 값을 레지스터 파일에 쓴다
    - 데이터 해저드
  - PC의 다음 값 상정: 증가된 PC값과 MEM 단계의 분기 주소 중에서 고른다
    - 컨트롤 해저드



### 데이터 패스의 파이프라인된 버전

- 파이프라인 레지스터
  - 두개의 단계를 구별한다
  - 이전주기에서 생성 된 정보 보유하고 있다



### 파이프라인 제어

1. IF: 없다 (명령어 메모리를 읽고 PC값을 쓰기 위한 제어 신호들은 항상 인가되므로)
2. ID: 없다 (이전 단계와 같이 매 클럭 사이클 마다 같은 일이 일어나기 때문에)
3. EX: RegDst, ALUOp, ALUSrc
4. MEM:  Branch(for beq),MemRead(for lw),MemWrite(for sw)
5. WB : MemtoReg, RegWrite



### 구조 해저드

- 자원 사용에 대한 충돌
- 하나의 메모리를 이용한 MIPS에서 파이프라인
  - Load/Store는 데이터 접근을 요구한다
  - 명령어 인출은 그 사이클을 지연시킬 것 이다
- 파이프라인 데이터 패스는 각각의 명령어/데이터 메모리들을 요구한다
  - 또는 개별적인 명령어/데이터 캐쉬들

